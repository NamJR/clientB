<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Client B</title>
</head>
<body>
    <h1>WebRTC Client B</h1>
    <button id="receiveCallButton">Receive Call</button>
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        const SERVER_URL = "http://192.168.1.190:5221/api/Signal"; // Äá»‹a chá»‰ API cá»§a server
        let localConnection;
        let connectionId = null;
        let localStream;

        // Láº¥y luá»“ng video tá»« webcam
        async function getLocalVideoStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                return localStream;
            } catch (err) {
                console.error("âŒ Failed to get local stream:", err);
                throw err;
            }
        }

        // Nháº­n cuá»™c gá»i vÃ  láº¥y thÃ´ng tin káº¿t ná»‘i
        async function receiveCall() {
            connectionId = prompt("ðŸ“ž Enter Connection ID to receive the call:");
            if (!connectionId) return;

            console.log("ðŸ“¥ Receiving Offer...");
            try {
                const response = await fetch(`${SERVER_URL}/offer/${connectionId}`);
                if (!response.ok) throw new Error(`âŒ Failed to get Offer. HTTP Status: ${response.status}`);

                const offer = await response.json();
                console.log("âœ… Offer received:", offer);
                await handleOffer(offer);
            } catch (error) {
                console.error("ðŸš¨ Error receiving call:", error);
            }
        }

        // Xá»­ lÃ½ offer tá»« Client A
        async function handleOffer(offer) {
            // Khá»Ÿi táº¡o peer connection vá»›i STUN vÃ  TURN giá»‘ng Client A
            localConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: "stun:ss-turn2.xirsys.com" },  // STUN server
                    { 
                        username: "TbA6DVsXL1TQp7IuvAbafLpc-AA_j_632XYXg7pp3OKIMbopbQL6kvkXiFfeNm7bAAAAAGfKnX5uYW1qcjE1MTE=", 
                        credential: "33fa8d42-fb24-11ef-809a-0242ac140004", 
                        urls: [
                            "turn:ss-turn2.xirsys.com:80?transport=udp",
                            "turn:ss-turn2.xirsys.com:3478?transport=udp",
                            "turn:ss-turn2.xirsys.com:80?transport=tcp",
                            "turn:ss-turn2.xirsys.com:3478?transport=tcp",
                            "turns:ss-turn2.xirsys.com:443?transport=tcp",
                            "turns:ss-turn2.xirsys.com:5349?transport=tcp"
                        ]
                    }
                ]
            });

            // Xá»­ lÃ½ ICE candidate
            localConnection.onicecandidate = event => {
                if (event.candidate) sendIceCandidate(event.candidate);
            };

            // Nháº­n track video tá»« Client A
            localConnection.ontrack = event => {
                console.log("ðŸ“¡ Received track from Client A:", event.streams[0]);
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            // Láº¥y luá»“ng video cá»¥c bá»™ vÃ  thÃªm vÃ o peer connection
            localStream = await getLocalVideoStream();
            localStream.getTracks().forEach(track => localConnection.addTrack(track, localStream));

            // Thiáº¿t láº­p remote description vá»›i offer tá»« Client A
            await localConnection.setRemoteDescription(new RTCSessionDescription(offer));

            // Táº¡o answer vÃ  gá»­i láº¡i cho server
            const answer = await localConnection.createAnswer();
            await localConnection.setLocalDescription(answer);

            await fetch(`${SERVER_URL}/answer/${connectionId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(answer),
            });

            console.log("âœ… Answer sent to server!");
            fetchIceCandidates();
        }

        // Gá»­i ICE candidate tá»›i server
        async function sendIceCandidate(candidate) {
            if (!connectionId) return;
            try {
                await fetch(`${SERVER_URL}/candidate/${connectionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(candidate),
                });
            } catch (error) {
                console.error("ðŸš¨ Error sending ICE Candidate:", error);
            }
        }

        // Láº¥y ICE candidates tá»« server vÃ  thÃªm vÃ o peer connection
        async function fetchIceCandidates() {
            setInterval(async () => {
                if (!connectionId || !localConnection.remoteDescription) return;
                try {
                    const response = await fetch(`${SERVER_URL}/candidate/${connectionId}`);
                    if (response.ok) {
                        const candidates = await response.json();
                        candidates.forEach(candidate => {
                            localConnection.addIceCandidate(new RTCIceCandidate(candidate))
                                .then(() => console.log("âœ… ICE Candidate added:", candidate))
                                .catch(err => console.error("ðŸš¨ Error adding ICE Candidate:", err));
                        });
                    }
                } catch (error) {
                    console.error("ðŸš¨ Error fetching ICE Candidate:", error);
                }
            }, 1000);
        }

        document.getElementById('receiveCallButton').addEventListener('click', receiveCall);
    </script>
</body>
</html>
