<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Client B</title>
</head>
<body>
    <h1>WebRTC Client B</h1>

    <button id="receiveCallButton">Receive Call</button>
    <button id="pauseResumeVideoButton">Pause Video</button>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>

    <script>
        const SERVER_URL = "http://192.168.1.12:5221/api/Signal"; // C·∫≠p nh·∫≠t ƒë√∫ng c·ªïng server

        let localConnection;
        let connectionId = null;
        let localStream = null;

        // L·∫•y stream video c·ªßa local
        async function getLocalVideoStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                return localStream;
            } catch (err) {
                console.error("‚ùå Failed to get local stream:", err);
            }
        }

        // Nh·∫≠n cu·ªôc g·ªçi
        async function receiveCall() {
            try {
                connectionId = prompt("üìû Enter Connection ID to receive the call:");
                if (!connectionId) throw new Error("‚ùå Connection ID is required!");

                console.log("üì• Receiving Offer...");
                const response = await fetch(`${SERVER_URL}/offer/${connectionId}`);

                if (!response.ok) {
                    throw new Error(`‚ùå Failed to get Offer. HTTP Status: ${response.status}`);
                }

                const offer = await response.json();
                console.log("‚úÖ Offer received:", offer);

                await handleOffer(offer);
                alert("üéâ Connected successfully!");

            } catch (error) {
                console.error("üö® Error receiving call:", error);
            }
        }

        // X·ª≠ l√Ω Offer v√† g·ª≠i Answer
        async function handleOffer(offer) {
            try {
                const config = {
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },  // STUN server mi·ªÖn ph√≠
                        {
                            urls: "turn:your-turn-server.com", // Thay b·∫±ng TURN server c·ªßa b·∫°n
                            username: "user123",
                            credential: "your_password"
                        }
                    ]
                };

                localConnection = new RTCPeerConnection(config);

                // L·∫Øng nghe ICE Candidate t·ª´ Client A
                localConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log("üì§ Sending ICE Candidate:", event.candidate);
                        sendIceCandidate(event.candidate);
                    }
                };

                // Khi nh·∫≠n stream t·ª´ Client A, hi·ªÉn th·ªã l√™n video
                localConnection.ontrack = (event) => {
                    console.log("üì° Receiving remote stream...");
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };

                // Thi·∫øt l·∫≠p Offer t·ª´ Client A l√†m Remote Description
                await localConnection.setRemoteDescription(new RTCSessionDescription(offer));

                // Th√™m local stream v√†o k·∫øt n·ªëi
                const stream = await getLocalVideoStream();
                stream.getTracks().forEach(track => localConnection.addTrack(track, stream));

                // T·∫°o Answer v√† g·ª≠i l·∫°i server
                const answer = await localConnection.createAnswer();
                await localConnection.setLocalDescription(answer);

                const answerResponse = await fetch(`${SERVER_URL}/answer/${connectionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(answer),
                });

                if (!answerResponse.ok) {
                    throw new Error(`‚ùå Failed to send Answer. HTTP Status: ${answerResponse.status}`);
                }

                console.log("‚úÖ Answer sent to server!");

            } catch (error) {
                console.error("üö® Error handling Offer:", error);
            }
        }

        // G·ª≠i ICE Candidate ƒë·∫øn server
        async function sendIceCandidate(candidate) {
            try {
                if (!connectionId) throw new Error("‚ùå Missing Connection ID!");

                const response = await fetch(`${SERVER_URL}/candidate/${connectionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(candidate),
                });

                if (!response.ok) {
                    throw new Error(`‚ùå Failed to send ICE Candidate. HTTP Status: ${response.status}`);
                }

                console.log("‚úÖ ICE Candidate sent!");

            } catch (error) {
                console.error("üö® Error sending ICE Candidate:", error);
            }
        }

        // T·∫°m d·ª´ng ho·∫∑c ti·∫øp t·ª•c video
        function toggleVideoPause() {
            if (!localStream) return;

            const videoTrack = localStream.getVideoTracks()[0];
            if (!videoTrack) return;

            if (videoTrack.enabled) {
                videoTrack.enabled = false;
                document.getElementById('pauseResumeVideoButton').textContent = 'Resume Video';
            } else {
                videoTrack.enabled = true;
                document.getElementById('pauseResumeVideoButton').textContent = 'Pause Video';
            }
        }

        // L·∫Øng nghe s·ª± ki·ªán click c·ªßa n√∫t "Receive Call"
        document.getElementById('receiveCallButton').addEventListener('click', receiveCall);

        // L·∫Øng nghe s·ª± ki·ªán click c·ªßa n√∫t "Pause/Resume Video"
        document.getElementById('pauseResumeVideoButton').addEventListener('click', toggleVideoPause);
    </script>
</body>
</html>
