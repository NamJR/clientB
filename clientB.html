<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Client B</title>
</head>
<body>
    <h1>WebRTC Client B</h1>
    <button id="receiveCallButton">Receive Call</button>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        const SERVER_URL = "http://192.168.1.72:5221/api/Signal"; // Cáº­p nháº­t Ä‘Ãºng Ä‘á»‹a chá»‰ server
        let localConnection;
        let connectionId = null;

        async function receiveCall() {
            connectionId = prompt("ðŸ“ž Enter Connection ID to receive the call:");
            if (!connectionId) return;

            console.log("ðŸ“¥ Fetching Offer...");
            try {
                const response = await fetch(`${SERVER_URL}/offer/${connectionId}`);
                if (!response.ok) throw new Error(`âŒ Failed to get Offer. HTTP Status: ${response.status}`);

                const offer = await response.json();
                console.log("âœ… Offer received:", offer);

                await setupPeerConnection();
                await localConnection.setRemoteDescription(new RTCSessionDescription(offer));

                console.log("ðŸŒ Creating Answer...");
                const answer = await localConnection.createAnswer();
                await localConnection.setLocalDescription(answer);

                console.log("ðŸ“¡ Sending Answer to Server...");
                await fetch(`${SERVER_URL}/answer/${connectionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(answer),
                });

                console.log("âœ… Answer sent successfully!");
                fetchIceCandidates();
            } catch (error) {
                console.error("ðŸš¨ Error receiving call:", error);
            }
        }

        async function setupPeerConnection() {
            const config = {
                iceServers: [
                    { urls: "stun:stun.l.google.com:19302" }, // STUN server miá»…n phÃ­
                    {
                        urls: "turn:your-turn-server.com", // Thay báº±ng TURN server cá»§a báº¡n náº¿u cáº§n
                        username: "user123",
                        credential: "your_password"
                    }
                ]
            };

            localConnection = new RTCPeerConnection(config);

            // Khi cÃ³ ICE Candidate má»›i, gá»­i Ä‘áº¿n server
            localConnection.onicecandidate = event => {
                if (event.candidate) sendIceCandidate(event.candidate);
            };

            // Khi nháº­n video tá»« Client A
            localConnection.ontrack = event => {
                console.log("ðŸ“¡ Receiving remote video stream...");
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            // Äáº£m báº£o Ä‘Ã m phÃ¡n láº¡i náº¿u cáº§n
            localConnection.onnegotiationneeded = async () => {
                console.log("ðŸ”„ Renegotiating connection...");
                try {
                    const offer = await localConnection.createOffer();
                    await localConnection.setLocalDescription(offer);
                } catch (error) {
                    console.error("ðŸš¨ Error during renegotiation:", error);
                }
            };
        }

        async function sendIceCandidate(candidate) {
            if (!connectionId) return;
            try {
                console.log("ðŸ“¤ Sending ICE Candidate...");
                await fetch(`${SERVER_URL}/candidate/${connectionId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(candidate),
                });
                console.log("âœ… ICE Candidate sent!");
            } catch (error) {
                console.error("ðŸš¨ Error sending ICE Candidate:", error);
            }
        }

        async function fetchIceCandidates() {
            setInterval(async () => {
                if (!connectionId) return;
                try {
                    console.log("ðŸ”„ Fetching ICE Candidates...");
                    const response = await fetch(`${SERVER_URL}/candidate/${connectionId}`);
                    if (response.ok) {
                        const candidates = await response.json();
                        candidates.forEach(candidate => {
                            localConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        });
                        console.log("âœ… ICE Candidates added successfully!");
                    }
                } catch (error) {
                    console.error("ðŸš¨ Error fetching ICE Candidate:", error);
                }
            }, 2000);
        }

        document.getElementById('receiveCallButton').addEventListener('click', receiveCall);
    </script>
</body>
</html>
